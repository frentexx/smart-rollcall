<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§æ ¡åœ’é»åç³»çµ± PWA (èª²å¾Œç­å°ˆç”¨)</title>
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- å­—é«”è¨­å®šèˆ‡æ¨£å¼ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 80px; 
        }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        .weekly-table-container {
            overflow-x: auto; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); background: white;
        }
        .weekly-table { min-width: 800px; width: 100%; border-collapse: collapse; }
        .weekly-table th, .weekly-table td { border: 1px solid #e5e7eb; padding: 8px; text-align: center; font-size: 0.85rem; }
        .weekly-table th { background-color: #f8fafc; color: #475569; font-weight: 600; }
        .sticky-col { position: sticky; left: 0; background-color: #ffffff; z-index: 10; border-right: 2px solid #e2e8f0; }
        
        .status-cell.Present { background-color: #d1fae5; color: #065f46; }
        .status-cell.Absent { background-color: #fee2e2; color: #991b1b; }
        .status-cell.Late { background-color: #fef3c7; color: #92400e; }
        .status-cell.Leave { background-color: #dbeafe; color: #1e40af; }

        .warning-row { background-color: #fff1f2 !important; }
        .warning-row .sticky-col { background-color: #fff1f2 !important; border-left: 4px solid #ef4444; }
        .warning-badge {
            display: inline-block; background-color: #ef4444; color: white;
            font-size: 0.7rem; padding: 2px 6px; border-radius: 999px;
            margin-left: 4px; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; display: flex; justify-content: space-around;
            padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 50;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #94a3b8; font-size: 0.75rem; cursor: pointer; transition: color 0.2s;
        }
        .nav-item.active { color: #3b82f6; }
        .nav-item i { font-size: 1.25rem; margin-bottom: 4px; }

        .rollcall-btn {
            aspect-ratio: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; border-radius: 12px;
            cursor: pointer; transition: transform 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .rollcall-btn:active { transform: scale(0.95); }
        .rc-Present { background: #10B981; color: white; }
        .rc-Absent { background: #EF4444; color: white; }
        .rc-Late { background: #F59E0B; color: white; }
        .rc-Leave { background: #3B82F6; color: white; }
        
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.8);
            display: flex; justify-content: center; align-items: center; z-index: 100;
        }
    </style>

    <!-- PWA Manifest & Service Worker Injection -->
    <script>
        const manifest = {
            "name": "æ™ºæ…§é»åç³»çµ±",
            "short_name": "é»åç³»çµ±",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f3f4f6",
            "theme_color": "#3b82f6",
            "icons": [{"src": "https://cdn-icons-png.flaticon.com/512/3135/3135768.png", "sizes": "192x192", "type": "image/png"}]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.head.appendChild(Object.assign(document.createElement('link'), {rel: 'manifest', href: URL.createObjectURL(manifestBlob)}));

        // Ver 3.0: å†æ¬¡æ›´æ–°å¿«å–
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'rollcall-v3.0-${new Date().getTime()}'; 
                self.addEventListener('install', e => self.skipWaiting());
                self.addEventListener('activate', e => {
                    e.waitUntil(caches.keys().then(keys => Promise.all(keys.map(key => { if(key !== CACHE_NAME) return caches.delete(key); }))));
                    self.clients.claim();
                });
                self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => caches.match(e.request))));
            `;
            navigator.serviceWorker.register(URL.createObjectURL(new Blob([swCode], {type: 'application/javascript'}))).catch(console.log);
        }
    </script>
</head>
<body>

    <!-- é ‚éƒ¨æ¨™é¡Œåˆ— -->
    <header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-40">
        <div>
            <h1 class="text-lg font-bold">æ™ºæ…§æ ¡åœ’é»åç³»çµ±</h1>
            <p class="text-xs opacity-80" id="current-user-info">è«‹å…ˆç™»å…¥</p>
        </div>
        <div class="flex items-center space-x-3">
             <button onclick="logout()" id="logout-btn" class="hidden text-xs bg-blue-700 px-3 py-1 rounded hover:bg-blue-800">ç™»å‡º</button>
        </div>
    </header>

    <!-- è¼‰å…¥å‹•ç•« -->
    <div id="loading" class="loading-overlay hidden">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
    </div>

    <!-- è¨Šæ¯æç¤ºæ¡† -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm z-50 hidden transition-opacity duration-300">
        æ“ä½œæˆåŠŸ
    </div>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="p-4 max-w-4xl mx-auto">
        
        <!-- é é¢ 0: ç™»å…¥ (æ”¯æ´ Email/Password) -->
        <div id="view-login" class="flex flex-col items-center justify-center min-h-[60vh] space-y-6">
            <div class="text-center mb-4">
                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-3xl">
                    <i class="fas fa-school"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">æ ¡åœ’å¸³è™Ÿç™»å…¥</h2>
                <p class="text-gray-500 text-sm mt-1">System Ver: 3.0 (Hybrid Login)</p>
            </div>
            
            <!-- ç™»å…¥è¡¨å–® -->
            <div id="login-form-container" class="w-full max-w-xs space-y-4">
                
                <!-- Email/Password ç™»å…¥å€å¡Š -->
                <div class="bg-white p-4 rounded-xl shadow border border-gray-200">
                    <h3 class="text-sm font-bold text-gray-700 mb-3 text-center">ä¿¡ç®±ç™»å…¥ (æ¨è–¦)</h3>
                    <input type="email" id="email-input" placeholder="è«‹è¼¸å…¥å­¸æ ¡ä¿¡ç®± (@ppsh...)" class="w-full p-2 border rounded mb-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <input type="password" id="password-input" placeholder="å¯†ç¢¼" class="w-full p-2 border rounded mb-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    
                    <div class="flex gap-2">
                        <button onclick="loginWithEmail()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold text-sm hover:bg-blue-700">ç™»å…¥</button>
                        <button onclick="registerWithEmail()" class="flex-1 bg-gray-100 text-blue-600 py-2 rounded font-bold text-sm hover:bg-gray-200">è¨»å†Š</button>
                    </div>
                </div>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">æˆ–</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>

                <!-- Google ç™»å…¥æŒ‰éˆ• (ä¿ç•™å‚™ç”¨) -->
                <button onclick="loginWithGoogle()" id="google-login-btn" class="w-full py-3 bg-white border border-gray-300 text-gray-700 font-bold rounded-xl shadow-sm hover:bg-gray-50 transition flex items-center justify-center gap-2 text-sm">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="Google Logo">
                    Google å¸³è™Ÿç™»å…¥
                </button>
            </div>
            
            <!-- ç™»å…¥å¾Œçš„è§’è‰²é¸æ“‡ (é è¨­éš±è—) -->
            <div id="role-selector" class="hidden w-full max-w-xs space-y-4 animate-fade-in">
                <p class="text-center text-green-600 font-bold mb-2"><i class="fas fa-check-circle mr-1"></i>é©—è­‰æˆåŠŸï¼è«‹é¸æ“‡èº«ä»½ï¼š</p>
                
                <button onclick="setRole('student')" class="w-full py-4 bg-white border-2 border-blue-500 text-blue-600 font-bold rounded-xl shadow-sm hover:bg-blue-50 transition flex items-center justify-center gap-3">
                    <i class="fas fa-user-graduate"></i> æˆ‘æ˜¯å­¸ç”Ÿ
                </button>
                
                <button onclick="showAdminLogin()" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-3">
                    <i class="fas fa-chalkboard-teacher"></i> æˆ‘æ˜¯è€å¸«/ç®¡ç†å“¡
                </button>
                
                <!-- ç®¡ç†å“¡å¯†ç¢¼è¼¸å…¥ -->
                <div id="admin-login-box" class="hidden w-full bg-white p-4 rounded-xl shadow border mt-2">
                    <input type="password" id="admin-pwd" placeholder="è¼¸å…¥ç®¡ç†å¯†ç¢¼ (admin123)" class="w-full p-2 border rounded mb-2">
                    <button onclick="checkAdmin()" class="w-full bg-indigo-800 text-white py-2 rounded font-semibold">ç¢ºèªé€²å…¥</button>
                </div>
            </div>
        </div>

        <!-- é é¢ 1-5 (çœç•¥ï¼Œèˆ‡ä¹‹å‰ç›¸åŒï¼Œä¿æŒä¸è®Šå³å¯) -->
        <!-- é é¢ 1: æ¯æ—¥é»å -->
        <div id="view-rollcall" class="hidden page-view">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-check-circle text-blue-500 mr-2"></i>æ¯æ—¥é»å</h2>
                <input type="date" id="rc-date" class="border rounded px-2 py-1 bg-white text-sm" onchange="loadRollCallData()">
            </div>
            <div id="rollcall-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3 mb-20">
                <p class="col-span-full text-center text-gray-500 py-10">è¼‰å…¥åå–®ä¸­...</p>
            </div>
            <button onclick="submitDailyRollCall()" class="fixed bottom-20 right-4 bg-green-500 hover:bg-green-600 text-white rounded-full p-4 shadow-xl z-40 flex items-center gap-2">
                <i class="fas fa-save"></i> <span class="text-sm font-bold">å„²å­˜ç´€éŒ„</span>
            </button>
        </div>

        <div id="view-audit" class="hidden page-view">
            <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-clipboard-list text-yellow-500 mr-2"></i>è«‹å‡å¯©æ ¸</h2>
            <div id="audit-list" class="space-y-3 pb-20"><div class="bg-white p-4 rounded-lg shadow text-center text-gray-500">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„è«‹å‡å–®</div></div>
        </div>

        <div id="view-stats" class="hidden page-view">
            <div class="mb-4">
                <h2 class="text-xl font-bold text-gray-800 mb-2"><i class="fas fa-chart-bar text-purple-500 mr-2"></i>é€±å ±è¡¨èˆ‡é è­¦</h2>
                <div class="flex items-center gap-2 bg-white p-3 rounded-lg shadow-sm">
                    <label class="text-sm text-gray-600 whitespace-nowrap">é¸æ“‡é€±æ¬¡:</label>
                    <input type="date" id="stats-date" class="border rounded p-1 w-full" onchange="calculateWeekRange()">
                </div>
                <p id="week-range-display" class="text-xs text-blue-600 mt-2 font-medium text-right"></p>
            </div>
            <div class="flex gap-2 text-xs mb-3 flex-wrap"><span class="px-2 py-1 bg-red-100 text-red-700 rounded border border-red-200">âš ï¸ æ› èª² > 4 ç¯€ (é è­¦)</span></div>
            <div class="weekly-table-container"><table class="weekly-table" id="weekly-stats-table"></table></div>
        </div>

        <div id="view-settings" class="hidden page-view">
            <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-cog text-gray-500 mr-2"></i>ç³»çµ±è¨­å®š</h2>
            <div class="bg-white p-4 rounded-lg shadow mb-6">
                <h3 class="font-bold text-gray-700 mb-2">åŒ¯å…¥å­¸ç”Ÿåå–® (CSV)</h3>
                <p class="text-xs text-gray-500 mb-3">æ ¼å¼ï¼šå¹³æ™‚ç­ç´š, å§“å (æ”¯æ´ Big5/UTF-8)</p>
                <div class="flex gap-2">
                    <input type="file" id="csv-file" accept=".csv" class="text-sm w-full">
                    <button onclick="importCSV()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm whitespace-nowrap">åŒ¯å…¥</button>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="font-bold text-gray-700 mb-2">Telegram æ¨æ’­è¨­å®š</h3>
                <div class="space-y-2">
                    <input type="text" id="tg-token" placeholder="Bot Token" class="w-full border p-2 rounded text-sm">
                    <input type="text" id="tg-chatid" placeholder="Chat ID" class="w-full border p-2 rounded text-sm">
                    <button onclick="saveTgSettings()" class="w-full bg-blue-100 text-blue-600 py-2 rounded text-sm font-bold">å„²å­˜è¨­å®š</button>
                </div>
            </div>
        </div>

        <div id="view-student" class="hidden page-view">
            <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 border-blue-500 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">è«‹å‡ç”³è«‹å–®</h2>
                <div class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">æˆ‘æ˜¯èª°?</label><select id="stu-select-self" class="w-full border p-2 rounded bg-gray-50 focus:ring-2 focus:ring-blue-500"><option value="">è¼‰å…¥ä¸­...</option></select></div>
                    <div class="grid grid-cols-2 gap-3"><div><label class="block text-xs text-gray-500">é–‹å§‹æ—¥æœŸ</label><input type="date" id="leave-start-date" class="w-full border p-2 rounded"></div><div><label class="block text-xs text-gray-500">æ™‚é–“</label><input type="time" id="leave-start-time" value="08:00" class="w-full border p-2 rounded"></div></div>
                    <div class="grid grid-cols-2 gap-3"><div><label class="block text-xs text-gray-500">çµæŸæ—¥æœŸ</label><input type="date" id="leave-end-date" class="w-full border p-2 rounded"></div><div><label class="block text-xs text-gray-500">æ™‚é–“</label><input type="time" id="leave-end-time" value="17:00" class="w-full border p-2 rounded"></div></div>
                    <div><label class="block text-xs text-gray-500">äº‹ç”±</label><textarea id="leave-reason" rows="2" class="w-full border p-2 rounded" placeholder="ç—…å‡ã€äº‹å‡..."></textarea></div>
                    <button onclick="submitStudentLeave()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-md transition transform active:scale-95">é€å‡ºç”³è«‹</button>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-bold text-gray-700 border-b pb-2 mb-2">æˆ‘çš„ç”³è«‹ç´€éŒ„</h3><ul id="my-leaves" class="text-sm space-y-2 max-h-40 overflow-y-auto"><li class="text-gray-400">å°šç„¡ç´€éŒ„</li></ul></div>
        </div>

    </main>

    <!-- åº•éƒ¨å°è¦½åˆ— -->
    <nav id="admin-nav" class="bottom-nav hidden">
        <div class="nav-item active" onclick="switchTab('view-rollcall', this)"><i class="fas fa-user-check"></i><span>é»å</span></div>
        <div class="nav-item" onclick="switchTab('view-audit', this)"><i class="fas fa-file-signature"></i><span>å¯©æ ¸</span></div>
        <div class="nav-item" onclick="switchTab('view-stats', this)"><i class="fas fa-chart-line"></i><span>é€±çµ±è¨ˆ</span></div>
        <div class="nav-item" onclick="switchTab('view-settings', this)"><i class="fas fa-sliders-h"></i><span>è¨­å®š</span></div>
    </nav>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, collection, addDoc, updateDoc, setDoc, query, where, onSnapshot, Timestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // ğŸ”´ å¼•å…¥ Email ç™»å…¥ç›¸é—œå‡½å¼
        import { getAuth, signInWithRedirect, GoogleAuthProvider, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // === Firebase é…ç½® (MyRollCall) ===
        const firebaseConfig = {
            apiKey: "AIzaSyDh06vfx4fW3kdosjRUOc9TaKidnp1gBjY",
            authDomain: "myrollcall-5f4b1.firebaseapp.com",
            projectId: "myrollcall-5f4b1",
            storageBucket: "myrollcall-5f4b1.firebasestorage.app",
            messagingSenderId: "328974301236",
            appId: "1:328974301236:web:edab016e396641a670f261",
            measurementId: "G-W7R50C6WQF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        window.db = db;
        let currentRole = 'guest';
        let roster = [];
        let rollCallState = {};

        // === 1. é©—è­‰ç‹€æ…‹ç›£è½ (çµ±ä¸€è™•ç† Google æˆ– Email ç™»å…¥) ===
        onAuthStateChanged(auth, (user) => {
            const loginContainer = document.getElementById('login-form-container');
            const roleSel = document.getElementById('role-selector');
            const logoutBtn = document.getElementById('logout-btn');
            const userInfo = document.getElementById('current-user-info');

            if (user) {
                // æª¢æŸ¥ç¶²åŸŸ (é©ç”¨æ–¼ Google å’Œ Email ç™»å…¥)
                if (user.email.endsWith('@ppsh.ptc.edu.tw')) {
                    console.log("ç™»å…¥æˆåŠŸ:", user.email);
                    userInfo.innerText = user.email;
                    loginContainer.classList.add('hidden'); // éš±è—ç™»å…¥è¡¨å–®
                    roleSel.classList.remove('hidden');     // é¡¯ç¤ºè§’è‰²é¸æ“‡
                    logoutBtn.classList.remove('hidden');
                    loadRosterFromDB();
                } else {
                    console.warn("ç¶²åŸŸéŒ¯èª¤:", user.email);
                    showToast('éŒ¯èª¤ï¼šé™ @ppsh.ptc.edu.tw ç¶²åŸŸä½¿ç”¨', true);
                    setTimeout(() => signOut(auth), 2000);
                }
            } else {
                userInfo.innerText = "è¨ªå®¢æ¨¡å¼";
                loginContainer.classList.remove('hidden');
                roleSel.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                document.getElementById('view-login').classList.remove('hidden');
                document.querySelectorAll('.page-view').forEach(el => el.classList.add('hidden'));
                document.getElementById('admin-nav').classList.add('hidden');
            }
        });

        // === ğŸ”´ æ–°å¢ï¼šEmail/å¯†ç¢¼ ç™»å…¥é‚è¼¯ ===
        window.loginWithEmail = function() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            if(!email || !password) return alert("è«‹è¼¸å…¥ä¿¡ç®±å’Œå¯†ç¢¼");
            
            showLoading(true);
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    showLoading(false);
                    showToast("ç™»å…¥æˆåŠŸ");
                })
                .catch((error) => {
                    showLoading(false);
                    console.error(error);
                    let msg = "ç™»å…¥å¤±æ•—";
                    if(error.code === 'auth/invalid-credential') msg = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
                    if(error.code === 'auth/user-not-found') msg = "æ­¤å¸³è™Ÿå°šæœªè¨»å†Š";
                    if(error.code === 'auth/wrong-password') msg = "å¯†ç¢¼éŒ¯èª¤";
                    alert(msg);
                });
        }

        // === ğŸ”´ æ–°å¢ï¼šEmail/å¯†ç¢¼ è¨»å†Šé‚è¼¯ ===
        window.registerWithEmail = function() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            if(!email || !password) return alert("è«‹è¼¸å…¥ä¿¡ç®±å’Œå¯†ç¢¼");
            if(password.length < 6) return alert("å¯†ç¢¼è‡³å°‘éœ€ 6 ç¢¼");
            
            // å‰ç«¯å…ˆæ“‹ç¶²åŸŸ
            if(!email.endsWith('@ppsh.ptc.edu.tw')) {
                return alert("è¨»å†Šå¤±æ•—ï¼šåƒ…é™ @ppsh.ptc.edu.tw ç¶²åŸŸè¨»å†Š");
            }

            showLoading(true);
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    showLoading(false);
                    showToast("è¨»å†ŠæˆåŠŸï¼å·²è‡ªå‹•ç™»å…¥");
                })
                .catch((error) => {
                    showLoading(false);
                    console.error(error);
                    let msg = "è¨»å†Šå¤±æ•—";
                    if(error.code === 'auth/email-already-in-use') msg = "æ­¤ä¿¡ç®±å·²è¢«è¨»å†Šï¼Œè«‹ç›´æ¥ç™»å…¥";
                    if(error.code === 'auth/weak-password') msg = "å¯†ç¢¼å¤ªå¼±";
                    alert(msg);
                });
        }

        // èˆŠçš„ Google ç™»å…¥ (ä¿ç•™å‚™ç”¨)
        window.loginWithGoogle = function() {
            const provider = new GoogleAuthProvider();
            signInWithRedirect(auth, provider);
        }

        window.logout = function() {
            signOut(auth).then(() => {
                location.reload();
            });
        }

        // (ä»¥ä¸‹ç‚ºåŸæœ‰çš„ App é‚è¼¯ï¼Œä¿æŒä¸è®Š)
        // === 2. è§’è‰²èˆ‡ UI é‚è¼¯ ===
        window.setRole = function(role) {
            currentRole = role;
            document.getElementById('view-login').classList.add('hidden');
            if (role === 'admin') {
                document.getElementById('admin-nav').classList.remove('hidden');
                switchTab('view-rollcall', document.querySelector('.nav-item'));
                document.getElementById('rc-date').value = new Date().toISOString().split('T')[0];
                loadRollCallData();
                loadAuditList();
            } else {
                document.getElementById('view-student').classList.remove('hidden');
                populateStudentSelect();
            }
        }
        
        window.showAdminLogin = function() { document.getElementById('admin-login-box').classList.remove('hidden'); }
        window.checkAdmin = function() {
            const pwd = document.getElementById('admin-pwd').value;
            if(pwd === 'admin123') { setRole('admin'); } else { showToast('å¯†ç¢¼éŒ¯èª¤'); }
        }

        window.switchTab = function(viewId, navEl) {
            document.querySelectorAll('.page-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(navEl) navEl.classList.add('active');
            if(viewId === 'view-stats' && !document.getElementById('stats-date').value) {
                document.getElementById('stats-date').value = new Date().toISOString().split('T')[0];
                calculateWeekRange();
            }
        }

        // === 3. æ ¸å¿ƒåŠŸèƒ½: é€±çµ±è¨ˆ ===
        window.getWeekRange = function(dateStr) {
            const date = new Date(dateStr);
            const day = date.getDay();
            const diffToMon = date.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(date);
            monday.setDate(diffToMon);
            monday.setHours(0,0,0,0);
            const days = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                days.push(d.toISOString().split('T')[0]);
            }
            return { days };
        }

        window.calculateWeekRange = async function() {
            const dateInput = document.getElementById('stats-date').value;
            if(!dateInput) return;
            showLoading(true);
            const { days } = getWeekRange(dateInput);
            document.getElementById('week-range-display').innerText = `${days[0]} ~ ${days[6]}`;

            const table = document.getElementById('weekly-stats-table');
            const dayNames = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
            let headerHTML = `<thead><tr><th class="sticky-col">å­¸ç”Ÿ</th>`;
            days.forEach((d, idx) => {
                headerHTML += `<th>${dayNames[idx]}<br><span class="text-xs font-normal">${d.slice(5).replace('-','/')}</span></th>`;
            });
            headerHTML += `<th>çµ±è¨ˆ</th></tr></thead>`;
            
            const q = query(collection(db, "attendance"), where("dateKey", ">=", days[0]), where("dateKey", "<=", days[6]));
            const snapshot = await getDocs(q);
            const attendanceMap = {};
            snapshot.forEach(doc => {
                const data = doc.data();
                if (!attendanceMap[data.studentId]) attendanceMap[data.studentId] = {};
                attendanceMap[data.studentId][data.dateKey] = data.status;
            });

            let bodyHTML = `<tbody>`;
            roster.forEach(stu => {
                const stuRecord = attendanceMap[stu.id] || {};
                let absentCount = 0;
                let rowCells = '';
                days.forEach(day => {
                    const status = stuRecord[day] || '-';
                    if (status === 'Absent') absentCount++;
                    const label = status === 'Present' ? 'åˆ°' : status === 'Absent' ? 'æ› ' : status === 'Late' ? 'é²' : status === 'Leave' ? 'å‡' : '-';
                    rowCells += `<td class="status-cell ${status}">${label}</td>`;
                });
                const isWarning = absentCount > 4;
                const warningBadge = isWarning ? '<span class="warning-badge">âš ï¸</span>' : '';
                bodyHTML += `<tr class="${isWarning ? 'warning-row' : ''}">
                    <td class="sticky-col font-bold text-gray-700 text-left px-2 whitespace-nowrap">
                        <span class="inline-block w-5 text-center mr-1">${stu.number}.</span>${stu.name} <span class="text-[10px] text-gray-400">(${stu.classLabel})</span> ${warningBadge}
                    </td>
                    ${rowCells}
                    <td class="text-xs font-bold ${isWarning ? 'text-red-600' : 'text-gray-500'}">${absentCount}</td></tr>`;
            });
            table.innerHTML = headerHTML + bodyHTML + `</tbody>`;
            showLoading(false);
        }

        // === 4. è³‡æ–™åº«èˆ‡é»åé‚è¼¯ ===
        function loadRosterFromDB() {
            onSnapshot(doc(db, "roster", "class_data"), (docSnap) => {
                if (docSnap.exists()) {
                    try {
                        roster = JSON.parse(docSnap.data().list);
                        if(currentRole === 'admin') loadRollCallData();
                    } catch(e) { console.error("Parse roster error", e); }
                }
            });
        }

        window.loadRollCallData = async function() {
            const dateStr = document.getElementById('rc-date').value;
            if(!dateStr || roster.length === 0) return;
            showLoading(true);
            const container = document.getElementById('rollcall-grid');
            container.innerHTML = '';
            
            const q = query(collection(db, "attendance"), where("dateKey", "==", dateStr));
            const snapshot = await getDocs(q);
            const savedState = {};
            snapshot.forEach(doc => savedState[doc.data().studentId] = doc.data().status);
            
            roster.forEach(stu => {
                const status = savedState[stu.id] || 'Present';
                rollCallState[stu.id] = status;
                
                const btn = document.createElement('div');
                btn.className = `rollcall-btn rc-${status}`;
                btn.id = `btn-${stu.id}`;
                btn.onclick = () => toggleStatus(stu.id);
                
                btn.innerHTML = `
                    <span class="text-2xl font-bold">${stu.number}</span>
                    <span class="text-xs mt-1 truncate w-full text-center px-1 font-bold">${stu.name}</span>
                    <span class="text-[10px] opacity-80">${stu.classLabel}</span>
                    <span class="text-[10px] opacity-80 status-text mt-1">${status==='Present'?'åˆ°':status==='Absent'?'ç¼º':status==='Late'?'é²':'å‡'}</span>
                `;
                container.appendChild(btn);
            });
            showLoading(false);
        }

        window.toggleStatus = function(uniqueId) {
            const types = ['Present', 'Absent', 'Late', 'Leave'];
            const next = types[(types.indexOf(rollCallState[uniqueId]) + 1) % types.length];
            rollCallState[uniqueId] = next;
            const btn = document.getElementById(`btn-${uniqueId}`);
            btn.className = `rollcall-btn rc-${next}`;
            btn.querySelector('.status-text').innerText = next==='Present'?'åˆ°':next==='Absent'?'ç¼º':next==='Late'?'é²':'å‡';
        }

        window.submitDailyRollCall = async function() {
            const dateStr = document.getElementById('rc-date').value;
            showLoading(true);
            const batch = writeBatch(db);
            roster.map(stu => {
                const docRef = doc(db, "attendance", `${dateStr}_${stu.id}`);
                batch.set(docRef, { 
                    studentId: stu.id, 
                    name: stu.name, 
                    classLabel: stu.classLabel, 
                    dateKey: dateStr, 
                    status: rollCallState[stu.id], 
                    timestamp: Timestamp.now() 
                });
            });
            await batch.commit();
            showLoading(false);
            showToast('é»åç´€éŒ„å·²å„²å­˜');
        }

        // === 5. è«‹å‡ã€å¯©æ ¸ã€åŒ¯å…¥ ===
        function populateStudentSelect() {
            const sel = document.getElementById('stu-select-self');
            sel.innerHTML = '<option value="">è«‹é¸æ“‡æ‚¨çš„å§“å</option>';
            roster.forEach(stu => sel.innerHTML += `<option value="${stu.id},${stu.name}">${stu.number}. ${stu.name} (${stu.classLabel})</option>`);
        }

        window.submitStudentLeave = async function() {
            const val = document.getElementById('stu-select-self').value;
            const [id, name] = val ? val.split(',') : [null, null];
            const reason = document.getElementById('leave-reason').value;
            if(!id || !reason) return showToast('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');

            showLoading(true);
            const studentObj = roster.find(s => s.id === id);
            const classLbl = studentObj ? studentObj.classLabel : "";

            await addDoc(collection(db, "leave_requests"), {
                studentId: id, 
                studentName: name,
                classLabel: classLbl,
                start: `${document.getElementById('leave-start-date').value} ${document.getElementById('leave-start-time').value}`,
                end: `${document.getElementById('leave-end-date').value} ${document.getElementById('leave-end-time').value}`,
                reason, status: 'Pending', submittedAt: Timestamp.now()
            });
            checkAndNotifyTelegram(id, name, reason, classLbl);
            showLoading(false);
            showToast('ç”³è«‹å·²é€å‡º');
        }

        function loadAuditList() {
            onSnapshot(query(collection(db, "leave_requests"), where("status", "==", "Pending")), (snap) => {
                const list = document.getElementById('audit-list');
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<div class="bg-white p-4 rounded text-center text-gray-400">ç„¡å¾…å¯©æ ¸é …ç›®</div>'; return; }
                snap.forEach(doc => {
                    const d = doc.data();
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-lg shadow border-l-4 border-yellow-400";
                    div.innerHTML = `<div class="flex justify-between">
                        <div>
                            <h4 class="font-bold">${d.studentName} <span class="text-xs text-gray-500">(${d.classLabel || 'æœªçŸ¥ç­ç´š'})</span></h4>
                            <p class="text-xs text-blue-600">${d.start}~${d.end}</p>
                            <p class="text-sm">${d.reason}</p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="auditLeave('${doc.id}','Approved')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">å‡†</button>
                            <button onclick="auditLeave('${doc.id}','Rejected')" class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs">é§</button>
                        </div>
                    </div>`;
                    list.appendChild(div);
                });
            });
        }
        window.auditLeave = async (id, status) => { await updateDoc(doc(db, "leave_requests", id), {status}); showToast('å·²æ›´æ–°'); };

        window.importCSV = function() {
            const file = document.getElementById('csv-file').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const lines = e.target.result.split('\n');
                const newRoster = [];
                let startIdx = 0;
                if (lines[0].includes("ç­ç´š") || lines[0].includes("Class")) startIdx = 1;

                let seatCounter = 1;
                for(let i=startIdx; i<lines.length; i++) {
                    const c = lines[i].split(',');
                    if(c.length>=2 && c[0].trim()) {
                        const uniqueId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                        newRoster.push({
                            id: uniqueId,          
                            classLabel: c[0].trim(), 
                            name: c[1].trim(),     
                            number: seatCounter++  
                        });
                    }
                }
                
                if(newRoster.length) {
                    if(confirm(`å³å°‡åŒ¯å…¥ ${newRoster.length} ç­†è³‡æ–™ã€‚æ³¨æ„ï¼šé‡æ–°åŒ¯å…¥æœƒå°è‡´èˆŠçš„å‡ºå¸­ç´€éŒ„ç„¡æ³•å°æ‡‰åˆ°æ–°åå–®ï¼Œç¢ºå®šå—ï¼Ÿ`)) {
                        await setDoc(doc(db, "roster", "class_data"), { list: JSON.stringify(newRoster), updatedAt: Timestamp.now() });
                        showToast(`åŒ¯å…¥æˆåŠŸï¼`);
                    }
                }
            };
            try { reader.readAsText(file, 'Big5'); } catch { reader.readAsText(file); }
        }

        window.saveTgSettings = () => {
            localStorage.setItem('tg_token', document.getElementById('tg-token').value);
            localStorage.setItem('tg_chatid', document.getElementById('tg-chatid').value);
            showToast('å·²å„²å­˜');
        }
        async function checkAndNotifyTelegram(id, name, reason, classLabel) {
            const token = localStorage.getItem('tg_token'), chat = localStorage.getItem('tg_chatid');
            if(!token || !chat) return;
            let warning = "";
            try {
                const snap = await getDocs(query(collection(db, "attendance"), where("studentId", "==", id), where("status", "==", "Absent")));
                if(snap.size > 4) warning = "\nâš ï¸ [ç³»çµ±é è­¦] æ› èª² > 4";
            } catch(e){}
            
            const msg = `ğŸ“ *å‡å–®*\nå­¸ç”Ÿ: ${name} (${classLabel})\näº‹ç”±: ${reason}${warning}`;
            
            fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chat_id: chat, text: msg, parse_mode: 'Markdown' })
            });
        }

        function showLoading(b) { document.getElementById('loading').classList.toggle('hidden', !b); }
        function showToast(msg, alert=false) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.className = `fixed top-20 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg text-sm z-50 transition-opacity duration-300 ${alert?'bg-red-600':'bg-gray-800'} text-white`;
            t.classList.remove('hidden'); t.style.opacity = 1;
            setTimeout(() => { t.style.opacity = 0; setTimeout(() => t.classList.add('hidden'), 300); }, 3000);
        }
        
        // Init Load
        document.getElementById('tg-token').value = localStorage.getItem('tg_token') || '';
        document.getElementById('tg-chatid').value = localStorage.getItem('tg_chatid') || '';
    </script>
</body>
</html>