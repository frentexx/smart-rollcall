<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§æ ¡åœ’é»åç³»çµ± PWA (å¤šç­ç´šç‰ˆ)</title>
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; padding-bottom: 80px; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .weekly-table-container { overflow-x: auto; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); background: white; }
        .weekly-table { min-width: 800px; width: 100%; border-collapse: collapse; }
        .weekly-table th, .weekly-table td { border: 1px solid #e5e7eb; padding: 8px; text-align: center; font-size: 0.85rem; }
        .weekly-table th { background-color: #f8fafc; color: #475569; font-weight: 600; }
        .sticky-col { position: sticky; left: 0; background-color: #ffffff; z-index: 10; border-right: 2px solid #e2e8f0; }
        .status-cell.Present { background-color: #d1fae5; color: #065f46; }
        .status-cell.Absent { background-color: #fee2e2; color: #991b1b; }
        .status-cell.Late { background-color: #fef3c7; color: #92400e; }
        .status-cell.Leave { background-color: #dbeafe; color: #1e40af; }
        .warning-row { background-color: #fff1f2 !important; }
        .warning-row .sticky-col { background-color: #fff1f2 !important; border-left: 4px solid #ef4444; }
        .warning-badge { display: inline-block; background-color: #ef4444; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 999px; margin-left: 4px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94a3b8; font-size: 0.75rem; cursor: pointer; transition: color 0.2s; }
        .nav-item.active { color: #3b82f6; }
        .nav-item i { font-size: 1.25rem; margin-bottom: 4px; }
        .rollcall-btn { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; transition: transform 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .rollcall-btn:active { transform: scale(0.95); }
        .rc-Present { background: #10B981; color: white; }
        .rc-Absent { background: #EF4444; color: white; }
        .rc-Late { background: #F59E0B; color: white; }
        .rc-Leave { background: #3B82F6; color: white; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 100; }
    </style>

    <script>
        const manifest = { "name": "æ™ºæ…§é»åç³»çµ±", "short_name": "é»åç³»çµ±", "start_url": ".", "display": "standalone", "background_color": "#f3f4f6", "theme_color": "#3b82f6", "icons": [{"src": "https://cdn-icons-png.flaticon.com/512/3135/3135768.png", "sizes": "192x192", "type": "image/png"}] };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.head.appendChild(Object.assign(document.createElement('link'), {rel: 'manifest', href: URL.createObjectURL(manifestBlob)}));
    </script>
</head>
<body>

    <header class="bg-blue-600 text-white p-3 shadow-md sticky top-0 z-40">
        <div class="flex justify-between items-center">
            <div class="flex flex-col">
                <h1 class="text-lg font-bold">æ™ºæ…§æ ¡åœ’é»åç³»çµ±</h1>
                <p class="text-xs opacity-80" id="current-user-info">è«‹å…ˆç™»å…¥</p>
            </div>
            <div class="flex items-center gap-2">
                <!-- ç­ç´šé¸æ“‡å™¨ (ç™»å…¥å¾Œé¡¯ç¤º) -->
                <select id="class-selector" class="hidden text-gray-800 text-sm p-1 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-300 max-w-[150px]" onchange="switchClass(this.value)">
                    <option value="">è¼‰å…¥ç­ç´š...</option>
                </select>
                <button onclick="logout()" id="logout-btn" class="hidden text-xs bg-blue-700 px-3 py-1 rounded hover:bg-blue-800 whitespace-nowrap">ç™»å‡º</button>
            </div>
        </div>
    </header>

    <div id="loading" class="loading-overlay hidden"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div></div>
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm z-50 hidden transition-opacity duration-300">æ“ä½œæˆåŠŸ</div>

    <main class="p-4 max-w-4xl mx-auto">
        
        <!-- ç™»å…¥é é¢ -->
        <div id="view-login" class="flex flex-col items-center justify-center min-h-[60vh] space-y-6">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-3xl"><i class="fas fa-school"></i></div>
                <h2 class="text-2xl font-bold text-gray-800">æ ¡åœ’å¸³è™Ÿç™»å…¥</h2>
                <p class="text-gray-500 text-sm mt-1">é™ <span class="font-mono text-blue-600 bg-blue-50 px-1 rounded">@ppsh.ptc.edu.tw</span> ç¶²åŸŸä½¿ç”¨</p>
                <p class="text-xs text-gray-400 mt-4">System Ver: 4.1 (TG Fix)</p>
            </div>
            
            <button onclick="loginWithGoogle()" id="google-login-btn" class="w-full max-w-xs py-4 bg-white border border-gray-300 text-gray-700 font-bold rounded-xl shadow-lg hover:bg-gray-50 transition flex items-center justify-center gap-3">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google Logo">
                ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
            </button>
            
            <div id="role-selector" class="hidden w-full max-w-xs space-y-4 animate-fade-in">
                <p class="text-center text-green-600 font-bold mb-2"><i class="fas fa-check-circle mr-1"></i>é©—è­‰æˆåŠŸï¼è«‹é¸æ“‡èº«ä»½ï¼š</p>
                <button onclick="setRole('student')" class="w-full py-4 bg-white border-2 border-blue-500 text-blue-600 font-bold rounded-xl shadow-sm hover:bg-blue-50 transition flex items-center justify-center gap-3"><i class="fas fa-user-graduate"></i> æˆ‘æ˜¯å­¸ç”Ÿ</button>
                <button onclick="showAdminLogin()" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-3"><i class="fas fa-chalkboard-teacher"></i> æˆ‘æ˜¯è€å¸«/ç®¡ç†å“¡</button>
                <div id="admin-login-box" class="hidden w-full bg-white p-4 rounded-xl shadow border mt-2"><input type="password" id="admin-pwd" placeholder="è¼¸å…¥ç®¡ç†å¯†ç¢¼ (admin123)" class="w-full p-2 border rounded mb-2"><button onclick="checkAdmin()" class="w-full bg-indigo-800 text-white py-2 rounded font-semibold">ç¢ºèªé€²å…¥</button></div>
            </div>
        </div>

        <!-- é é¢ 1: æ¯æ—¥é»å -->
        <div id="view-rollcall" class="hidden page-view">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-check-circle text-blue-500 mr-2"></i>æ¯æ—¥é»å</h2>
                <input type="date" id="rc-date" class="border rounded px-2 py-1 bg-white text-sm" onchange="loadRollCallData()">
            </div>
            <div id="rollcall-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3 mb-20"><p class="col-span-full text-center text-gray-500 py-10">è«‹å…ˆå»ºç«‹æˆ–é¸æ“‡ç­ç´šï¼Œä¸¦åŒ¯å…¥åå–®ã€‚</p></div>
            <button onclick="submitDailyRollCall()" class="fixed bottom-20 right-4 bg-green-500 hover:bg-green-600 text-white rounded-full p-4 shadow-xl z-40 flex items-center gap-2"><i class="fas fa-save"></i> <span class="text-sm font-bold">å„²å­˜ç´€éŒ„</span></button>
        </div>

        <!-- é é¢ 2: è«‹å‡å¯©æ ¸ -->
        <div id="view-audit" class="hidden page-view">
            <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-clipboard-list text-yellow-500 mr-2"></i>è«‹å‡å¯©æ ¸</h2>
            <p class="text-xs text-gray-500 mb-2" id="audit-class-hint">ç›®å‰é¡¯ç¤ºç­ç´šï¼šè¼‰å…¥ä¸­...</p>
            <div id="audit-list" class="space-y-3 pb-20"><div class="bg-white p-4 rounded-lg shadow text-center text-gray-500">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„è«‹å‡å–®</div></div>
        </div>

        <!-- é é¢ 3: é€±çµ±è¨ˆ -->
        <div id="view-stats" class="hidden page-view">
            <div class="mb-4">
                <h2 class="text-xl font-bold text-gray-800 mb-2"><i class="fas fa-chart-bar text-purple-500 mr-2"></i>é€±å ±è¡¨èˆ‡é è­¦</h2>
                <div class="flex items-center gap-2 bg-white p-3 rounded-lg shadow-sm">
                    <label class="text-sm text-gray-600 whitespace-nowrap">é¸æ“‡é€±æ¬¡:</label>
                    <input type="date" id="stats-date" class="border rounded p-1 w-full" onchange="calculateWeekRange()">
                </div>
                <p id="week-range-display" class="text-xs text-blue-600 mt-2 font-medium text-right"></p>
            </div>
            <div class="flex gap-2 text-xs mb-3 flex-wrap"><span class="px-2 py-1 bg-red-100 text-red-700 rounded border border-red-200">âš ï¸ æ› èª² > 4 ç¯€ (é è­¦)</span></div>
            <div class="weekly-table-container"><table class="weekly-table" id="weekly-stats-table"></table></div>
        </div>

        <!-- é é¢ 4: ç³»çµ±è¨­å®š -->
        <div id="view-settings" class="hidden page-view">
            <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-cog text-gray-500 mr-2"></i>ç³»çµ±è¨­å®š</h2>
            
            <div class="bg-white p-4 rounded-lg shadow mb-6 border-l-4 border-indigo-500">
                <h3 class="font-bold text-gray-700 mb-2">ç­ç´šç®¡ç†</h3>
                <div class="flex gap-2 mb-3">
                    <input type="text" id="new-class-name" placeholder="è¼¸å…¥æ–°ç¤¾åœ˜/ç­ç´šåç¨±" class="w-full border p-2 rounded text-sm">
                    <button onclick="createClass()" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm whitespace-nowrap">æ–°å¢</button>
                </div>
                <div class="border-t pt-3">
                    <p class="text-sm text-gray-600 mb-1">ç•¶å‰é¸æ“‡ï¼š<span id="setting-current-class" class="font-bold text-indigo-600">æœªé¸æ“‡</span></p>
                    <button onclick="deleteCurrentClass()" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200">åˆªé™¤æ­¤ç­ç´š (å«åå–®èˆ‡ç´€éŒ„)</button>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow mb-6">
                <h3 class="font-bold text-gray-700 mb-2">åŒ¯å…¥å­¸ç”Ÿåå–® (CSV)</h3>
                <p class="text-xs text-gray-500 mb-1">å°‡åŒ¯å…¥è‡³ï¼š<span id="import-target-class" class="font-bold text-blue-600">æœªé¸æ“‡ç­ç´š</span></p>
                <div class="flex gap-2">
                    <input type="file" id="csv-file" accept=".csv" class="text-sm w-full">
                    <button onclick="importCSV()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm whitespace-nowrap">åŒ¯å…¥</button>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="font-bold text-gray-700 mb-2">Telegram æ¨æ’­è¨­å®š (å…¨æ ¡é€šç”¨)</h3>
                <p class="text-xs text-gray-400 mb-2">è¨­å®šå¾Œå°‡å­˜å…¥è³‡æ–™åº«ï¼Œæ‰€æœ‰è£ç½®åŒæ­¥ç”Ÿæ•ˆã€‚</p>
                <div class="space-y-2">
                    <input type="text" id="tg-token" placeholder="Bot Token" class="w-full border p-2 rounded text-sm">
                    <input type="text" id="tg-chatid" placeholder="Chat ID" class="w-full border p-2 rounded text-sm">
                    <button onclick="saveTgSettings()" class="w-full bg-blue-100 text-blue-600 py-2 rounded text-sm font-bold">å„²å­˜è‡³é›²ç«¯</button>
                </div>
            </div>
        </div>

        <!-- é é¢ 5: å­¸ç”Ÿè«‹å‡ä»‹é¢ -->
        <div id="view-student" class="hidden page-view">
            <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 border-blue-500 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">è«‹å‡ç”³è«‹å–®</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æˆ‘è¦è«‹å“ªå€‹ç­ç´šçš„å‡?</label>
                        <select id="stu-class-select" class="w-full border p-2 rounded bg-gray-50 focus:ring-2 focus:ring-blue-500" onchange="loadStudentListForLeave(this.value)">
                            <option value="">-- è«‹é¸æ“‡ç­ç´š --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æˆ‘æ˜¯èª°?</label>
                        <select id="stu-name-select" class="w-full border p-2 rounded bg-gray-50 focus:ring-2 focus:ring-blue-500" disabled>
                            <option value="">è«‹å…ˆé¸æ“‡ç­ç´š</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-500">é–‹å§‹æ—¥æœŸ</label><input type="date" id="leave-start-date" class="w-full border p-2 rounded"></div>
                        <div><label class="block text-xs text-gray-500">æ™‚é–“</label><input type="time" id="leave-start-time" value="08:00" class="w-full border p-2 rounded"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-500">çµæŸæ—¥æœŸ</label><input type="date" id="leave-end-date" class="w-full border p-2 rounded"></div>
                        <div><label class="block text-xs text-gray-500">æ™‚é–“</label><input type="time" id="leave-end-time" value="17:00" class="w-full border p-2 rounded"></div>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500">äº‹ç”±</label>
                        <textarea id="leave-reason" rows="2" class="w-full border p-2 rounded" placeholder="ç—…å‡ã€äº‹å‡..."></textarea>
                    </div>
                    <button onclick="submitStudentLeave()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-md transition transform active:scale-95">é€å‡ºç”³è«‹</button>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="font-bold text-gray-700 border-b pb-2 mb-2">æˆ‘çš„ç”³è«‹ç´€éŒ„</h3>
                <ul id="my-leaves" class="text-sm space-y-2 max-h-40 overflow-y-auto"><li class="text-gray-400">å°šç„¡ç´€éŒ„</li></ul>
            </div>
        </div>

    </main>

    <nav id="admin-nav" class="bottom-nav hidden">
        <div class="nav-item active" onclick="switchTab('view-rollcall', this)"><i class="fas fa-user-check"></i><span>é»å</span></div>
        <div class="nav-item" onclick="switchTab('view-audit', this)"><i class="fas fa-file-signature"></i><span>å¯©æ ¸</span></div>
        <div class="nav-item" onclick="switchTab('view-stats', this)"><i class="fas fa-chart-line"></i><span>é€±çµ±è¨ˆ</span></div>
        <div class="nav-item" onclick="switchTab('view-settings', this)"><i class="fas fa-sliders-h"></i><span>è¨­å®š</span></div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, collection, addDoc, updateDoc, setDoc, getDoc, deleteDoc, query, where, onSnapshot, Timestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // === Firebase é…ç½® (MyRollCall) ===
        const firebaseConfig = {
            apiKey: "AIzaSyDh06vfx4fW3kdosjRUOc9TaKidnp1gBjY",
            authDomain: "myrollcall-5f4b1.firebaseapp.com",
            projectId: "myrollcall-5f4b1",
            storageBucket: "myrollcall-5f4b1.firebasestorage.app",
            messagingSenderId: "328974301236",
            appId: "1:328974301236:web:edab016e396641a670f261",
            measurementId: "G-W7R50C6WQF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        window.db = db;
        let currentRole = 'guest';
        let roster = [];
        let rollCallState = {};
        
        // Ver 4.0: å¤šç­ç´šç‹€æ…‹
        let currentClassId = null;
        let currentClassName = "";
        let allClasses = [];

        // === 1. é©—è­‰ç‹€æ…‹ç›£è½ ===
        onAuthStateChanged(auth, (user) => {
            const loginBtn = document.getElementById('google-login-btn');
            const roleSel = document.getElementById('role-selector');
            const logoutBtn = document.getElementById('logout-btn');
            const userInfo = document.getElementById('current-user-info');
            const classSelector = document.getElementById('class-selector');

            if (user) {
                if (user.email.endsWith('@ppsh.ptc.edu.tw')) {
                    console.log("ç™»å…¥æˆåŠŸ:", user.email);
                    userInfo.innerText = user.email;
                    loginBtn.classList.add('hidden');
                    roleSel.classList.remove('hidden');
                    logoutBtn.classList.remove('hidden');
                    loadClasses();
                    // è€å¸«ç™»å…¥æ™‚è‡ªå‹•è¼‰å…¥ TG è¨­å®šåˆ°è¼¸å…¥æ¡† (æ–¹ä¾¿æŸ¥çœ‹)
                    loadTgSettingsToUI();
                } else {
                    console.warn("ç¶²åŸŸéŒ¯èª¤:", user.email);
                    showToast('éŒ¯èª¤ï¼šé™ @ppsh.ptc.edu.tw ç¶²åŸŸä½¿ç”¨', true);
                    setTimeout(() => signOut(auth), 2000);
                }
            } else {
                userInfo.innerText = "è¨ªå®¢æ¨¡å¼";
                loginBtn.classList.remove('hidden');
                roleSel.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                classSelector.classList.add('hidden');
                document.getElementById('view-login').classList.remove('hidden');
                document.querySelectorAll('.page-view').forEach(el => el.classList.add('hidden'));
                document.getElementById('admin-nav').classList.add('hidden');
            }
        });

        window.loginWithGoogle = function() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(err => alert("ç™»å…¥å¤±æ•—:\n" + err.message));
        }
        window.logout = function() { signOut(auth).then(() => { location.reload(); }); }

        // === 2. ç­ç´šç®¡ç†é‚è¼¯ ===
        function loadClasses() {
            const q = query(collection(db, "classes"));
            onSnapshot(q, (snap) => {
                allClasses = [];
                const selector = document.getElementById('class-selector');
                const stuClassSelector = document.getElementById('stu-class-select');
                
                selector.innerHTML = '';
                stuClassSelector.innerHTML = '<option value="">-- è«‹é¸æ“‡ç­ç´š --</option>';

                if(snap.empty) { selector.innerHTML = '<option value="">ç„¡ç­ç´š</option>'; return; }

                snap.forEach(doc => {
                    allClasses.push({ id: doc.id, ...doc.data() });
                    selector.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`;
                    stuClassSelector.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`;
                });

                if (allClasses.length > 0) {
                    if (!currentClassId || !allClasses.find(c => c.id === currentClassId)) {
                        switchClass(allClasses[0].id);
                    } else {
                        selector.value = currentClassId;
                        switchClass(currentClassId);
                    }
                    selector.classList.remove('hidden');
                }
            });
        }

        window.switchClass = function(classId) {
            const cls = allClasses.find(c => c.id === classId);
            if(!cls) return;
            currentClassId = classId;
            currentClassName = cls.name;
            roster = cls.list ? JSON.parse(cls.list) : [];
            
            document.getElementById('setting-current-class').innerText = currentClassName;
            document.getElementById('import-target-class').innerText = currentClassName;
            document.getElementById('audit-class-hint').innerText = `ç›®å‰é¡¯ç¤ºç­ç´šï¼š${currentClassName}`;
            document.getElementById('class-selector').value = classId;

            if(currentRole === 'admin') {
                const activeTab = document.querySelector('.nav-item.active span').innerText;
                if(activeTab === 'é»å') loadRollCallData();
                if(activeTab === 'å¯©æ ¸') loadAuditList();
                if(activeTab === 'é€±çµ±è¨ˆ') calculateWeekRange();
            }
        }

        window.createClass = async function() {
            const name = document.getElementById('new-class-name').value;
            if(!name) return alert("è«‹è¼¸å…¥ç­ç´šåç¨±");
            showLoading(true);
            await addDoc(collection(db, "classes"), { name: name, list: "[]", createdAt: Timestamp.now() });
            document.getElementById('new-class-name').value = '';
            showLoading(false);
            showToast(`å·²å»ºç«‹ï¼š${name}`);
        }

        window.deleteCurrentClass = async function() {
            if(!currentClassId) return;
            if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${currentClassName}ã€å—ï¼Ÿ\næ­¤å‹•ä½œå°‡åŒæ™‚åˆªé™¤è©²ç­ç´šçš„æ‰€æœ‰åå–®èˆ‡ç´€éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸï¼`)) return;
            showLoading(true);
            await deleteDoc(doc(db, "classes", currentClassId));
            showLoading(false);
            showToast("ç­ç´šå·²åˆªé™¤");
            currentClassId = null;
        }

        // === 3. è§’è‰²èˆ‡ UI é‚è¼¯ ===
        window.setRole = function(role) {
            currentRole = role;
            document.getElementById('view-login').classList.add('hidden');
            if (role === 'admin') {
                document.getElementById('admin-nav').classList.remove('hidden');
                document.getElementById('class-selector').disabled = false;
                switchTab('view-rollcall', document.querySelector('.nav-item'));
                document.getElementById('rc-date').value = new Date().toISOString().split('T')[0];
                if(currentClassId) loadRollCallData();
            } else {
                document.getElementById('view-student').classList.remove('hidden');
                document.getElementById('class-selector').classList.add('hidden');
            }
        }
        
        window.showAdminLogin = function() { document.getElementById('admin-login-box').classList.remove('hidden'); }
        window.checkAdmin = function() {
            const pwd = document.getElementById('admin-pwd').value;
            if(pwd === 'admin123') { setRole('admin'); } else { showToast('å¯†ç¢¼éŒ¯èª¤'); }
        }

        window.switchTab = function(viewId, navEl) {
            document.querySelectorAll('.page-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(navEl) navEl.classList.add('active');
            if(viewId === 'view-rollcall') loadRollCallData();
            if(viewId === 'view-audit') loadAuditList();
            if(viewId === 'view-stats') {
                if(!document.getElementById('stats-date').value) document.getElementById('stats-date').value = new Date().toISOString().split('T')[0];
                calculateWeekRange();
            }
        }

        // === 4. é»åèˆ‡çµ±è¨ˆ ===
        window.loadRollCallData = async function() {
            if(!currentClassId) return;
            const dateStr = document.getElementById('rc-date').value;
            showLoading(true);
            const container = document.getElementById('rollcall-grid');
            container.innerHTML = '';
            
            if(roster.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">æ­¤ç­ç´šå°šç„¡åå–®ï¼Œè«‹è‡³è¨­å®šåŒ¯å…¥ã€‚</p>';
                showLoading(false); return;
            }

            const qAttendance = query(collection(db, "attendance"), where("dateKey", "==", dateStr), where("classId", "==", currentClassId));
            const snapAttendance = await getDocs(qAttendance);
            const savedState = {};
            snapAttendance.forEach(doc => savedState[doc.data().studentId] = doc.data().status);

            const qLeaves = query(collection(db, "leave_requests"), where("status", "==", "Approved"), where("classId", "==", currentClassId));
            const snapLeaves = await getDocs(qLeaves);
            const leaveMap = {};
            snapLeaves.forEach(doc => {
                const data = doc.data();
                if (dateStr >= data.start.split(' ')[0] && dateStr <= data.end.split(' ')[0]) leaveMap[data.studentId] = true;
            });
            
            roster.forEach(stu => {
                let status = 'Present';
                if (savedState[stu.id]) status = savedState[stu.id];
                else if (leaveMap[stu.id]) status = 'Leave';
                rollCallState[stu.id] = status;
                const btn = document.createElement('div');
                btn.className = `rollcall-btn rc-${status}`;
                btn.id = `btn-${stu.id}`;
                btn.onclick = () => toggleStatus(stu.id);
                btn.innerHTML = `<span class="text-2xl font-bold">${stu.number}</span><span class="text-xs mt-1 truncate w-full text-center px-1 font-bold">${stu.name}</span><span class="text-[10px] opacity-80">${stu.classLabel}</span><span class="text-[10px] opacity-80 status-text mt-1">${status==='Present'?'åˆ°':status==='Absent'?'ç¼º':status==='Late'?'é²':'å‡'}</span>`;
                container.appendChild(btn);
            });
            showLoading(false);
        }

        window.toggleStatus = function(uniqueId) {
            const types = ['Present', 'Absent', 'Late', 'Leave'];
            const next = types[(types.indexOf(rollCallState[uniqueId]) + 1) % types.length];
            rollCallState[uniqueId] = next;
            const btn = document.getElementById(`btn-${uniqueId}`);
            btn.className = `rollcall-btn rc-${next}`;
            btn.querySelector('.status-text').innerText = next==='Present'?'åˆ°':next==='Absent'?'ç¼º':next==='Late'?'é²':'å‡';
        }

        window.submitDailyRollCall = async function() {
            if(!currentClassId) return alert("æœªé¸æ“‡ç­ç´š");
            const dateStr = document.getElementById('rc-date').value;
            showLoading(true);
            const batch = writeBatch(db);
            roster.map(stu => {
                const docRef = doc(db, "attendance", `${currentClassId}_${dateStr}_${stu.id}`);
                batch.set(docRef, { classId: currentClassId, studentId: stu.id, name: stu.name, classLabel: stu.classLabel, dateKey: dateStr, status: rollCallState[stu.id], timestamp: Timestamp.now() });
            });
            await batch.commit();
            showLoading(false);
            showToast('é»åç´€éŒ„å·²å„²å­˜');
        }

        window.getWeekRange = function(dateStr) {
            const date = new Date(dateStr);
            const day = date.getDay();
            const diffToMon = date.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(date);
            monday.setDate(diffToMon);
            monday.setHours(0,0,0,0);
            const days = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                days.push(d.toISOString().split('T')[0]);
            }
            return { days };
        }

        window.calculateWeekRange = async function() {
            if(!currentClassId) return;
            const dateInput = document.getElementById('stats-date').value;
            if(!dateInput) return;
            showLoading(true);
            const { days } = getWeekRange(dateInput);
            document.getElementById('week-range-display').innerText = `${days[0]} ~ ${days[6]}`;
            const table = document.getElementById('weekly-stats-table');
            const dayNames = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
            let headerHTML = `<thead><tr><th class="sticky-col">å­¸ç”Ÿ</th>`;
            days.forEach((d, idx) => { headerHTML += `<th>${dayNames[idx]}<br><span class="text-xs font-normal">${d.slice(5).replace('-','/')}</span></th>`; });
            headerHTML += `<th>çµ±è¨ˆ</th></tr></thead>`;
            
            const q = query(collection(db, "attendance"), where("dateKey", ">=", days[0]), where("dateKey", "<=", days[6]), where("classId", "==", currentClassId));
            const snapshot = await getDocs(q);
            const attendanceMap = {};
            snapshot.forEach(doc => {
                const data = doc.data();
                if (!attendanceMap[data.studentId]) attendanceMap[data.studentId] = {};
                attendanceMap[data.studentId][data.dateKey] = data.status;
            });
            let bodyHTML = `<tbody>`;
            roster.forEach(stu => {
                const stuRecord = attendanceMap[stu.id] || {};
                let absentCount = 0;
                let rowCells = '';
                days.forEach(day => {
                    const status = stuRecord[day] || '-';
                    if (status === 'Absent') absentCount++;
                    const label = status === 'Present' ? 'åˆ°' : status === 'Absent' ? 'æ› ' : status === 'Late' ? 'é²' : status === 'Leave' ? 'å‡' : '-';
                    rowCells += `<td class="status-cell ${status}">${label}</td>`;
                });
                const isWarning = absentCount > 4;
                const warningBadge = isWarning ? '<span class="warning-badge">âš ï¸</span>' : '';
                bodyHTML += `<tr class="${isWarning ? 'warning-row' : ''}"><td class="sticky-col font-bold text-gray-700 text-left px-2 whitespace-nowrap"><span class="inline-block w-5 text-center mr-1">${stu.number}.</span>${stu.name} <span class="text-[10px] text-gray-400">(${stu.classLabel})</span> ${warningBadge}</td>${rowCells}<td class="text-xs font-bold ${isWarning ? 'text-red-600' : 'text-gray-500'}">${absentCount}</td></tr>`;
            });
            table.innerHTML = headerHTML + bodyHTML + `</tbody>`;
            showLoading(false);
        }

        // === 5. å­¸ç”Ÿç«¯é‚è¼¯ ===
        window.loadStudentListForLeave = function(classId) {
            const nameSelect = document.getElementById('stu-name-select');
            if(!classId) { nameSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡ç­ç´š</option>'; nameSelect.disabled = true; return; }
            const targetClass = allClasses.find(c => c.id === classId);
            if(targetClass) {
                const list = targetClass.list ? JSON.parse(targetClass.list) : [];
                nameSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡æ‚¨çš„å§“å --</option>';
                list.forEach(stu => { nameSelect.innerHTML += `<option value="${stu.id}">${stu.number}. ${stu.name} (${stu.classLabel})</option>`; });
                nameSelect.disabled = false;
            }
        }

        window.submitStudentLeave = async function() {
            const classId = document.getElementById('stu-class-select').value;
            const stuId = document.getElementById('stu-name-select').value;
            if(!classId || !stuId) return showToast('è«‹é¸æ“‡ç­ç´šèˆ‡å§“å');
            const targetClass = allClasses.find(c => c.id === classId);
            const rosterList = targetClass ? JSON.parse(targetClass.list) : [];
            const studentObj = rosterList.find(s => s.id === stuId);
            const reason = document.getElementById('leave-reason').value;
            if(!reason) return showToast('è«‹å¡«å¯«äº‹ç”±');

            showLoading(true);
            await addDoc(collection(db, "leave_requests"), {
                classId: classId, className: targetClass.name, studentId: stuId, studentName: studentObj.name,
                classLabel: studentObj.classLabel,
                start: `${document.getElementById('leave-start-date').value} ${document.getElementById('leave-start-time').value}`,
                end: `${document.getElementById('leave-end-date').value} ${document.getElementById('leave-end-time').value}`,
                reason, status: 'Pending', submittedAt: Timestamp.now()
            });
            // ä¿®æ­£ï¼šå¾ DB è®€å– Token ç™¼é€
            checkAndNotifyTelegram(stuId, studentObj.name, reason, studentObj.classLabel);
            showLoading(false);
            showToast('ç”³è«‹å·²é€å‡º');
        }

        function loadAuditList() {
            if(!currentClassId) return;
            const q = query(collection(db, "leave_requests"), where("status", "==", "Pending"), where("classId", "==", currentClassId));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('audit-list');
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<div class="bg-white p-4 rounded text-center text-gray-400">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„è«‹å‡å–®</div>'; return; }
                snap.forEach(doc => {
                    const d = doc.data();
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-lg shadow border-l-4 border-yellow-400";
                    div.innerHTML = `<div class="flex justify-between"><div><h4 class="font-bold">${d.studentName} <span class="text-xs text-gray-500">(${d.classLabel})</span></h4><p class="text-xs text-blue-600">${d.start}~${d.end}</p><p class="text-sm">${d.reason}</p></div><div class="flex flex-col gap-2"><button onclick="auditLeave('${doc.id}','Approved')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">å‡†</button><button onclick="auditLeave('${doc.id}','Rejected')" class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs">é§</button></div></div>`;
                    list.appendChild(div);
                });
            });
        }
        window.auditLeave = async (id, status) => { await updateDoc(doc(db, "leave_requests", id), {status}); showToast('å·²æ›´æ–°'); };

        window.importCSV = function() {
            if(!currentClassId) return alert("è«‹å…ˆå»ºç«‹æˆ–é¸æ“‡ä¸€å€‹ç­ç´šï¼");
            const file = document.getElementById('csv-file').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const lines = e.target.result.split('\n');
                const newRoster = [];
                let startIdx = 0;
                if (lines[0].includes("ç­ç´š") || lines[0].includes("Class")) startIdx = 1;
                let seatCounter = 1;
                for(let i=startIdx; i<lines.length; i++) {
                    const c = lines[i].split(',');
                    if(c.length>=2 && c[0].trim()) {
                        const uniqueId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                        newRoster.push({ id: uniqueId, classLabel: c[0].trim(), name: c[1].trim(), number: seatCounter++ });
                    }
                }
                if(newRoster.length) {
                    if(confirm(`å³å°‡åŒ¯å…¥ ${newRoster.length} ç­†è³‡æ–™è‡³ã€Œ${currentClassName}ã€ã€‚\né€™å°‡è¦†è“‹è©²ç­ç´šç¾æœ‰åå–®ï¼Œç¢ºå®šå—ï¼Ÿ`)) {
                        await updateDoc(doc(db, "classes", currentClassId), { list: JSON.stringify(newRoster), updatedAt: Timestamp.now() });
                        showToast(`åŒ¯å…¥æˆåŠŸï¼`);
                        roster = newRoster;
                        loadRollCallData();
                    }
                }
            };
            try { reader.readAsText(file, 'Big5'); } catch { reader.readAsText(file); }
        }

        // === 6. Telegram è¨­å®šåŒæ­¥é‚è¼¯ (Ver 4.1) ===
        
        // è€å¸«ï¼šè¼‰å…¥è¨­å®šåˆ° UI
        async function loadTgSettingsToUI() {
            const docSnap = await getDoc(doc(db, "system", "telegram_config"));
            if (docSnap.exists()) {
                document.getElementById('tg-token').value = docSnap.data().token || '';
                document.getElementById('tg-chatid').value = docSnap.data().chatId || '';
            }
        }

        // è€å¸«ï¼šå„²å­˜è¨­å®šåˆ°è³‡æ–™åº«
        window.saveTgSettings = async () => {
            const token = document.getElementById('tg-token').value;
            const chatId = document.getElementById('tg-chatid').value;
            if(!token || !chatId) return alert("è«‹è¼¸å…¥å®Œæ•´ Token èˆ‡ Chat ID");
            
            showLoading(true);
            // å¯«å…¥ system/telegram_config (ç¢ºä¿è³‡æ–™åº«è¦å‰‡å…è¨±å¯«å…¥ system é›†åˆ)
            await setDoc(doc(db, "system", "telegram_config"), { token, chatId });
            showLoading(false);
            showToast('å·²å„²å­˜è‡³é›²ç«¯');
        }

        // å­¸ç”Ÿï¼šå¾è³‡æ–™åº«è®€å–è¨­å®šä¸¦ç™¼é€
        async function checkAndNotifyTelegram(id, name, reason, classLabel) {
            // 1. å¾è³‡æ–™åº«æŠ“ Token
            const docSnap = await getDoc(doc(db, "system", "telegram_config"));
            if (!docSnap.exists()) return console.log("Telegram config not found in DB");
            
            const { token, chatId } = docSnap.data();
            if(!token || !chatId) return;

            let warning = "";
            try { const snap = await getDocs(query(collection(db, "attendance"), where("studentId", "==", id), where("status", "==", "Absent"))); if(snap.size > 4) warning = "\nâš ï¸ [ç³»çµ±é è­¦] æ› èª² > 4"; } catch(e){}
            
            // ä¿®æ­£ï¼šClass Name é¡¯ç¤ºå•é¡Œ
            // ç”±æ–¼é€™è£¡æ˜¯ç•°æ­¥å‘¼å«ï¼ŒcurrentClassName è®Šæ•¸åœ¨å­¸ç”Ÿç«¯æ˜¯ç©ºçš„(å› ç‚ºæ²’é¸ä¸Šæ–¹é¸å–®)
            // ä½†æˆ‘å€‘åœ¨ submit æ™‚å·²ç¶“å¾ targetClass æŠ“åˆ°äº† className å­˜å…¥ DB
            // é€™è£¡ç°¡å–®é¡¯ç¤º classLabel (å¹³æ™‚ç­ç´š) å³å¯ï¼Œé‡é»æ˜¯é€šçŸ¥é€å‡º
            
            fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chat_id: chatId, text: `ğŸ“ *å‡å–®*\nå­¸ç”Ÿ: ${name} (${classLabel})\näº‹ç”±: ${reason}${warning}`, parse_mode: 'Markdown' })
            });
        }

        function showLoading(b) { document.getElementById('loading').classList.toggle('hidden', !b); }
        function showToast(msg, alert=false) { const t = document.getElementById('toast'); t.innerText = msg; t.className = `fixed top-20 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg text-sm z-50 transition-opacity duration-300 ${alert?'bg-red-600':'bg-gray-800'} text-white`; t.classList.remove('hidden'); t.style.opacity = 1; setTimeout(() => { t.style.opacity = 0; setTimeout(() => t.classList.add('hidden'), 300); }, 3000); }
    </script>
</body>
</html>